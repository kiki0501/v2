version: '3.8'

services:
  vertex-ai-proxy-browser:
    build:
      context: .
      dockerfile: Dockerfile.browser
    container_name: vertex-ai-proxy-v2-browser
    ports:
      - "7860:7860"    # API 端口
      - "28881:28881"  # WebSocket 端口
      - "6080:6080"    # noVNC Web 界面端口
      - "5900:5900"    # VNC 直连端口
    volumes:
      # 挂载凭证文件以持久化
      - ./credentials.json:/app/credentials.json
      - ./stats.json:/app/stats.json
      - ./auth_bundle.json:/app/auth_bundle.json
      # 挂载浏览器数据目录（保存登录状态）
      - browser-data:/root/.config/google-chrome
      # 挂载日志目录
      - ./logs:/var/log/supervisor
    environment:
      - DISPLAY=:99
      - NOGUI=1
      - PYTHONUNBUFFERED=1
      - API_KEY=${API_KEY:-your-secret-api-key-here}
      - VNC_PASSWORD=${VNC_PASSWORD:-vertex}
    restart: unless-stopped
    shm_size: '2gb'  # 增加共享内存，Chrome 需要
    networks:
      - vertex-proxy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860/v1/models"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  browser-data:
    driver: local

networks:
  vertex-proxy-network:
    driver: bridge